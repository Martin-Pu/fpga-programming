
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Approach &#8212; FPGA Fan Control  documentation</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=62ba249389abaaa9ffc34bf36a076bdc1d65ee18" type="text/css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=f31d14ad54b65d19161ba51d4ffff3a77ae00456"></script>
    <link rel="shortcut icon" href="_static/Testsetup.png"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Results" href="ch4-results.html" />
    <link rel="prev" title="Relevant concepts" href="ch2-relevant-concepts.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="_static/Testsetup.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">FPGA Fan Control  documentation</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Contents
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="ch1-problem.html">
   The Problem
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="ch2-relevant-concepts.html">
   Relevant concepts
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Approach
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="ch4-results.html">
   Results
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="_sources/ch3-approach.md.txt"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.md</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#general-approach">
   General Approach
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#individual-modules">
   Individual Modules
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#spi-spimcp3201">
     SPI (SPIMCP3201)
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#conversion-modules">
     Conversion Modules
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#voltage-to-temperature">
       Voltage to Temperature
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#temperature-to-duty-cycle">
       Temperature to Duty Cycle
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#readtach">
     ReadTach
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#seven-segment-driver">
     Seven Segment Driver
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#hardware-circuit">
   Hardware Circuit
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Approach</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#general-approach">
   General Approach
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#individual-modules">
   Individual Modules
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#spi-spimcp3201">
     SPI (SPIMCP3201)
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#conversion-modules">
     Conversion Modules
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#voltage-to-temperature">
       Voltage to Temperature
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#temperature-to-duty-cycle">
       Temperature to Duty Cycle
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#readtach">
     ReadTach
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#seven-segment-driver">
     Seven Segment Driver
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#hardware-circuit">
   Hardware Circuit
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section id="approach">
<h1>Approach<a class="headerlink" href="#approach" title="Permalink to this headline">#</a></h1>
<section id="general-approach">
<h2>General Approach<a class="headerlink" href="#general-approach" title="Permalink to this headline">#</a></h2>
<p>To achieve high flexibility for the planed future expansion of the project, it was structured in Blocks. This is shown in the Block Diagram.
Each Block was programmed individually and tested on hardware before moving on to the next Block.
For the ReadTach Module an extra Simulation-file was used as described later.
For the rest, a general Simulation-file was build to be able to test the general stability of the software.</p>
<p><img alt="Diagram" src="_images/BlockDiagramm.PNG" /></p>
<p>All modules were programmed in behavioral Verilog where possible.
All the Modules were programmed in the Vivado IDE.
Structural assignments were sparely used to connect wires and registers. The Stretch goals are marked in green.</p>
</section>
<section id="individual-modules">
<h2>Individual Modules<a class="headerlink" href="#individual-modules" title="Permalink to this headline">#</a></h2>
<section id="spi-spimcp3201">
<h3>SPI (SPIMCP3201)<a class="headerlink" href="#spi-spimcp3201" title="Permalink to this headline">#</a></h3>
<p>For this module a serial communication bus had to be created. The SPI communication of the MCP3201 is given in the <a class="reference external" href="http://ww1.microchip.com/downloads/en/devicedoc/21290f.pdf">datasheet</a></p>
<p><img alt="Serial Kommunikation" src="_images/SPICommunication.PNG" /></p>
<p>According to this timing diagram, communication was implemented.</p>
<p>A 100 kHz clock divider was used to generate the SPI clock.
Another clock divider was used to generate a 1 Hz clock to sample the ADC once per second.<br />
In the second clock divider the samples also get read.</p>
<p>Because the ADC needs time to sample the data, the first two bits are floating and the third is a Null bit. That's why in the code not all the 16 bit values of the received data are used. The last clock cycle is used to power down the ADC.</p>
<p>For debugging the bottom (0-11) LEDs were connected to the raw Data received by the ADC.</p>
</section>
<section id="conversion-modules">
<h3>Conversion Modules<a class="headerlink" href="#conversion-modules" title="Permalink to this headline">#</a></h3>
<p>The implementation here was strait forward with behavioral Verilog tho a few problems were encountered, which are described in the following segments.</p>
<p>Each module has Input data, Output Data, and a clk, at which rate the conversion has to be made.
Here the standard 100 MHz clock was used as clock, but in hindsight a One Hz Clock would have sufficed, since the Sensor Data is also only refreshed at this frequency.</p>
<section id="voltage-to-temperature">
<h4>Voltage to Temperature<a class="headerlink" href="#voltage-to-temperature" title="Permalink to this headline">#</a></h4>
<p>Problems were encountered when trying to divide by numbers, which is required by some conversion-formulas. It was discovered that division is not directly possible in Verilog.</p>
<p>A workaround approach was chosen where the number is multiplied by 2/x, where x is the divisor. This factor got calculated on a calculator and then entered in the code. The result is then shifted by one bit to the right to divide by two.</p>
<p>The formula for the Temperature Sensor had to be calibrated. This was also done as described in <a class="reference external" href="https://www.aeq-web.com/pt1000-temperature-sensor-arduino-lm358-messwandler/?lang=en">this</a> article.</p>
<p>Recapped a potentiometer was used to get the exact resistance value for different Temperatures, and the Value of the ADC was read for those. The potentiometer Value was calibrated with a potentiometer, so the temperature value could only be calibrated to its accuracy.</p>
</section>
<section id="temperature-to-duty-cycle">
<h4>Temperature to Duty Cycle<a class="headerlink" href="#temperature-to-duty-cycle" title="Permalink to this headline">#</a></h4>
<p>For this conversion, for now a simple formula will be generated based on this Graph:</p>
<p><img alt="TemperatureGraph" src="_images/TemperatureGraph.PNG" /></p>
<p>For future work a feedback control loop should be developed.</p>
</section>
</section>
<section id="readtach">
<h3>ReadTach<a class="headerlink" href="#readtach" title="Permalink to this headline">#</a></h3>
<p>The approach to this Module was to use the external Tach signal received from the fan, as a clk signal for an always block.
This approach didn't work because it is hardly possible and not recommended to use external signals as clock signals.</p>
<p>So the standard 100 MHz clock was used. This means, the rising edge had to be manually detected with code.</p>
<p>The plan is to update the RPM once per second, which only gives a maximum resolution of 30 RPM, but for this use-case it's good enough.</p>
</section>
<section id="seven-segment-driver">
<h3>Seven Segment Driver<a class="headerlink" href="#seven-segment-driver" title="Permalink to this headline">#</a></h3>
<p>Here the seven Segment Driver developed during project 9 of the digital logic course of <a class="reference external" href="https://www.realdigital.org/doc/0bb5bcc5527bc3161178769ce85e6463">realdigital</a> was used.</p>
<p>The used architecture is described in this image:</p>
<p><img alt="SevenSegment" src="_images/SevenSegment.PNG" /></p>
<p>It is used to display the Temperature and RPM. It alternates between these two values. To achieve this the Seven Segment Module had to be expended by a One Hz Clock Divider and a 1 bit counter.</p>
</section>
</section>
<section id="hardware-circuit">
<h2>Hardware Circuit<a class="headerlink" href="#hardware-circuit" title="Permalink to this headline">#</a></h2>
<p>For the Hardware circuit inspiration was drawn from an article from [AEQ-Web] <a class="reference external" href="https://www.aeq-web.com/pt1000-temperature-sensor-arduino-lm358-messwandler/?lang=en">1</a>
The interface to the Fan was implemented according to [specification for PWM Controlled Fans] <a class="reference external" href="https://www.glkinst.com/cables/cable_pics/4_Wire_PWM_Spec.pdf">2</a></p>
<p>With these information a circuit for the full project could be developed.</p>
</section>
</section>


              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="ch2-relevant-concepts.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Relevant concepts</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="ch4-results.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Results</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Martin Putz<br/>
  
      &copy; Copyright Creative Commons Attribution 4.0 International License.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>